name: UltraVNC via ngrok (Windows)

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Set up job
      run: echo "Starting UltraVNC workflow"

    # -----------------------------
    # Download UltraVNC FULL MSI
    # -----------------------------
    - name: Download UltraVNC (FULL MSI)
      shell: powershell
      run: |
        Invoke-WebRequest `
          -Uri "https://www.uvnc.com/component/jdownloads/send/0-/470-ultravnc-1-4-3-0-x64-setup.html" `
          -OutFile ultravnc.msi

    # -----------------------------
    # Install UltraVNC
    # -----------------------------
    - name: Install UltraVNC (FULL)
      shell: powershell
      run: |
        msiexec /i ultravnc.msi /quiet /norestart

    # -----------------------------
    # Set VNC password (CORRECT WAY)
    # -----------------------------
    - name: Set UltraVNC password
      shell: powershell
      run: |
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v passwd  /t REG_BINARY /d 3132333435363738 /f
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v passwd2 /t REG_BINARY /d 3132333435363738 /f
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v AuthRequired /t REG_DWORD /d 1 /f
        Write-Host "VNC password set (password = 12345678)"

    # -----------------------------
    # Enable clipboard + remote access
    # -----------------------------
    - name: Enable clipboard & access
      shell: powershell
      run: |
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v EnableFileTransfer /t REG_DWORD /d 1 /f
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v EnableClipboard /t REG_DWORD /d 1 /f

    # -----------------------------
    # Allow VNC through firewall
    # -----------------------------
    - name: Allow VNC through firewall
      shell: powershell
      run: |
        netsh advfirewall firewall add rule name="UltraVNC" dir=in action=allow protocol=TCP localport=5900

    # -----------------------------
    # Start UltraVNC service
    # -----------------------------
    - name: Start UltraVNC service
      shell: powershell
      run: |
        net start uvnc_service || net start uvnc_server

    # -----------------------------
    # Download ngrok
    # -----------------------------
    - name: Download ngrok
      shell: powershell
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .

    # -----------------------------
    # Configure ngrok
    # -----------------------------
    - name: Configure ngrok
      shell: powershell
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        .\ngrok.exe config add-authtoken $Env:NGROK_AUTH_TOKEN

    # -----------------------------
    # Start ngrok TCP tunnel
    # -----------------------------
    - name: Start ngrok VNC tunnel
      shell: powershell
      run: |
        Start-Process -NoNewWindow -FilePath ".\ngrok.exe" -ArgumentList "tcp 5900"

    # -----------------------------
    # Keep session alive
    # -----------------------------
    - name: Keep session alive
      shell: powershell
      run: |
        while ($true) { Start-Sleep -Seconds 300 }
