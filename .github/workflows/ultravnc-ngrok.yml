name: Windows UltraVNC (ngrok FIXED)

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    steps:
    - name: Download UltraVNC (DIRECT MSI)
      shell: powershell
      run: |
        $ProgressPreference = 'SilentlyContinue'
        curl.exe -L -o ultravnc.msi `
          https://downloads.sourceforge.net/project/ultravnc/UltraVNC/1.4.3.0/UltraVNC_1_4_3_X64_Setup.msi
        Write-Output "UltraVNC MSI downloaded"

    - name: Install UltraVNC Server (silent)
      shell: powershell
      run: |
        msiexec /i ultravnc.msi /quiet /norestart ADDLOCAL=Server

    - name: Set UltraVNC password
      shell: powershell
      run: |
        & "C:\Program Files\uvnc bvba\UltraVNC\setpasswd.exe" 12345678

    - name: Enable clipboard + access
      shell: powershell
      run: |
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v EnableClipboard /t REG_DWORD /d 1 /f
        reg add "HKLM\SOFTWARE\uvnc bvba\UltraVNC" /v LoopbackOnly /t REG_DWORD /d 0 /f

    - name: Allow VNC through firewall
      shell: powershell
      run: |
        netsh advfirewall firewall add rule name="UltraVNC TCP 5900" dir=in action=allow protocol=TCP localport=5900

    - name: Start UltraVNC service
      shell: powershell
      run: |
        Start-Service uvnc_service

    - name: Download ngrok
      shell: powershell
      run: |
        curl.exe -L -o ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip
        Expand-Archive ngrok.zip -DestinationPath .

    - name: Configure ngrok
      shell: powershell
      run: |
        .\ngrok.exe config add-authtoken "$Env:NGROK_AUTH_TOKEN"

    - name: Start ngrok VNC tunnel
      shell: powershell
      run: |
        Start-Process -NoNewWindow -FilePath ".\ngrok.exe" -ArgumentList "tcp 5900"
        Start-Sleep 10
        Invoke-RestMethod http://127.0.0.1:4040/api/tunnels

    - name: Keep session alive
      shell: powershell
      run: |
        while ($true) { Start-Sleep 300 }
